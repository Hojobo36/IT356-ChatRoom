<!DOCTYPE html>
<html lang="en">

<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();

  // Listen for new messages from other users
  socket.on('newMessage', (message) => {
    const messagesDiv = document.getElementById('messages');

    // Create a new message element
    const messageDiv = document.createElement('div');
    messageDiv.classList.add('message');
    messageDiv.innerHTML = `<h2>${message.userMessage}</h2><p>by ${message.userName}</p>`;

    // Append the new message to the messages container
    messagesDiv.appendChild(messageDiv);

    // Scroll to the bottom if the user is already at the bottom
    if (messagesDiv.scrollHeight - messagesDiv.scrollTop === messagesDiv.clientHeight) {
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
  });

  // Persist user name in localStorage
  window.addEventListener('DOMContentLoaded', () => {
    const nameInput = document.querySelector('input[name="userName"]');

    // Load saved name if it exists
    const savedName = localStorage.getItem('userName');
    if (savedName) {
      nameInput.value = savedName;
    }

    // Save the name to localStorage whenever it changes
    nameInput.addEventListener('input', () => {
      localStorage.setItem('userName', nameInput.value);
    });

    // Add submit event listener to the form
    const form = document.querySelector('form');
    form.addEventListener('submit', async (event) => {
      event.preventDefault(); // Prevent page reload on form submission

      const userName = document.querySelector('input[name="userName"]').value;
      const userMessage = document.querySelector('input[name="userMessage"]').value;

      // Send the message data via fetch (POST request)
      const response = await fetch('/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ userName, userMessage })
      });

      if (response.ok) {
        // Clear the message input field after sending
        document.querySelector('input[name="userMessage"]').value = '';
      } else {
        console.error('Failed to send message');
      }
    });
  });
</script>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat Room</title>
  <style>
    /* Your existing styles remain unchanged */
  </style>
</head>

<body>
<h1>Welcome to the Chat Room</h1>

<div id="messages">
  <% data.forEach(element => { %>
    <div class="message">
      <h2><%= element.userMessage %></h2>
      <p>by <%= element.userName %></p>
    </div>
  <% }) %>
</div>

<div class="form-container">
  <h2>Add a Message</h2>
  <form action="/" method="post">
    <input type="text" placeholder="Your Name" name="userName" required>
    <input type="text" placeholder="Type a message..." name="userMessage" required>
    <button type="submit">Send</button>
  </form>
</div>

<button class="toggle-btn" id="toggle-theme-btn">Switch to Dark Mode</button>

<script>
  // Dark mode toggle script as before...
</script>
</body>

</html>
